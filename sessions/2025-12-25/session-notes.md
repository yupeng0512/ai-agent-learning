# Session: 2025-12-25

## 主题：Agent 架构设计方法论

### 今日学习目标
- 理解主流 Agent 架构的区别
- 掌握架构组合设计思路
- 形成完整的 Agent 设计方法论

---

## 一、主流架构对比

### 四种架构核心区别

| 架构 | 核心思想 | 优势 | 局限 | 适用场景 |
|------|---------|------|------|---------|
| **ReAct** | 推理+行动循环 | 简单、通用 | 复杂任务易迷失 | 单步工具调用 |
| **Plan-and-Execute** | 先规划后执行 | 结构清晰、不遗漏 | 计划可能过时 | 多步骤任务 |
| **Reflexion** | 自我反思改进 | 能从错误学习 | 成本高 | 需要迭代优化 |
| **LATS** | 树搜索探索 | 探索多条路径 | 计算量大 | 复杂推理 |

### 执行流程对比

```
【ReAct - 走一步看一步】
用户请求 → 思考 → 行动 → 观察 → 思考 → ... → 完成
问题：没有全局视角，容易遗漏

【Plan-and-Execute - 先规划后执行】
用户请求 → 制定完整计划 → 执行步骤1 → 执行步骤2 → ... → 整合结果
优势：不会遗漏，可追踪，可调整

【Reflexion - 做完反思再改】
用户请求 → 第一版输出 → 评估 → 改进 → 再评估 → ... → 最终版
适用：写作、代码等需要迭代优化的任务
```

### 关键洞察

- **ReAct 的问题**：处理"调研3家公司写报告"这种任务时，可能搜完第一家就忘了其他的
- **架构不是单选题**：复杂任务需要组合架构

---

## 二、架构组合实战：Code Review Agent

### 场景分析

Code Review Agent 需要：
1. 读取 PR 中的代码变更
2. 检查代码风格
3. 检查潜在 bug
4. 检查安全漏洞
5. 生成 Review 意见

### 架构选型

**选择：Plan-and-Execute + Reflexion**

理由：
- 需要全局视角统筹所有检查项 → Plan-and-Execute
- 完成后需要反思检查是否遗漏 → Reflexion

```
Plan-and-Execute（全局规划）
    ↓
制定计划: 1.读代码 → 2.查风格 → 3.查bug → 4.查安全 → 5.汇总
    ↓
逐步执行各检查任务
    ↓
Reflexion（反思检查）
    ↓
"是否遗漏重要问题？Review 意见是否完整？"
    ↓
补充/修正 → 最终输出
```

---

## 三、大规模任务优化：分布式 Agent

### 问题：100+ 文件的大型 PR 怎么处理？

三个挑战：
1. **Token 限制**：无法一次加载所有文件
2. **执行时间**：串行处理太慢
3. **检查质量**：如何保证不遗漏

### 解决方案

| 挑战 | 解决方案 | 实现方式 |
|------|---------|---------|
| Token 限制 | 独立上下文 | 每个 Worker 只加载当前文件 |
| 执行时间 | 并行处理 | Map-Reduce 模式 |
| 检查质量 | 分层 Reflexion | 局部反思 + 全局反思 |

### 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        主 Agent (Orchestrator)                  │
│  ┌─────────┐   ┌─────────────┐   ┌──────────┐   ┌───────────┐  │
│  │ Planner │ → │ Dispatcher  │ → │Aggregator│ → │ Reflector │  │
│  │ 分片策略 │   │ 任务分发    │   │ 结果汇总 │   │ 全局反思  │  │
│  └─────────┘   └─────────────┘   └──────────┘   └───────────┘  │
└─────────────────────────────────────────────────────────────────┘
                          │
          ┌───────────────┼───────────────┐
          ↓               ↓               ↓
    ┌──────────┐   ┌──────────┐   ┌──────────┐
    │ Worker 1 │   │ Worker 2 │   │ Worker 3 │   (并行)
    │ 文件1-10 │   │ 文件11-20│   │ 文件21-30│
    │ +局部反思│   │ +局部反思│   │ +局部反思│
    └──────────┘   └──────────┘   └──────────┘
```

---

## 四、Agent 设计方法论（"实习生标准"）

### 核心理念

> 一个合格的 Agent 至少要达到"实习生标准"——能执行、会思考、能进化

### 四大维度

#### 1️⃣ 执行能力 —— "能把事情做完"

**架构设计**
- 单/多 Agent 选型
- 组合架构：Plan-Execute + Reflexion
- 串行/并行策略

**上下文管理**
- Token 优化：Skill/Tool 按需加载
- 独立上下文：避免相互干扰

#### 2️⃣ 思考能力 —— "能独立判断"

**知识库管理（承上启下）**
- 短期记忆：当前任务上下文
- 长期记忆：历史经验、用户偏好
- 外部知识：RAG 检索增强

**任务分析**
- 简单/复杂任务识别
- 是否需要迭代优化
- 步骤依赖关系
- 状态管理需求

#### 3️⃣ 进化能力 —— "能从错误中学习"

**分层 Reflexion**
- 局部反思：Worker 级别，检查单任务
- 全局反思：主 Agent 级别，检查系统性问题

#### 4️⃣ 工程保障 —— "生产级要求"

**质量保证**
- 可观测性（日志/追踪）
- 错误隔离（非阻塞节点失败不影响整体）
- 人工介入点

**成本控制**
- 任务分级 → 模型分级
- Token 缓存命中

---

## 五、面试话术

### 开场白

> "我认为一个合格的 Agent 至少要达到**实习生标准**——能执行、会思考、能进化。基于这个标准，我会从四个维度设计..."

### 加分点

- 成本控制：任务分级用不同模型、缓存机制
- 容错机制：错误隔离、降级策略、超时处理
- 可扩展性：水平扩展、能力扩展

---

## 六、今日代码产出

| 文件 | 内容 |
|------|------|
| `code-snippets/langchain/agent_architectures.py` | 三种架构对比实现 |
| `code-snippets/langchain/code_review_agent.py` | 组合架构示例 |
| `code-snippets/langchain/distributed_review_agent.py` | 分布式 Agent 完整实现 |
| `notes/agent-architecture-design.md` | 完整方法论文档 |

---

## 七、学习收获

1. **架构不是单选题**：根据任务特点组合使用
2. **分层思维**：上下文分层、反思分层、错误处理分层
3. **工程思维**：不只是"能跑"，还要考虑成本、容错、可观测
4. **面试准备**：形成了有记忆点的回答框架（"实习生标准"）

---

## 八、下一步计划

- [ ] 框架实战：深入 LangChain / AutoGen / CrewAI
- [ ] RAG 系统：检索增强生成
- [ ] MCP 协议：工具调用标准化

---

*Session 时长: ~2小时*
*学习状态: 高效*
